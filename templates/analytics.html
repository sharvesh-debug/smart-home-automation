{% extends "layout.html" %}

{% block page_title %}Analytics{% endblock %}

{% block page_styles %}

<style>
    .analytics-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
        margin-bottom: 30px;
    }

    @media (min-width: 768px) {
        .analytics-grid {
            grid-template-columns: 2fr 1fr;
        }
    }

    .analytics-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow-medium);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .analytics-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-large);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-title i {
        color: var(--accent-color);
    }

    .view-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .view-btn {
        padding: 8px 16px;
        border: 2px solid var(--border-color);
        background: var(--surface-bg);
        color: var(--text-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .view-btn.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .view-btn:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }

    .chart-container canvas {
        max-height: 100%;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (min-width: 576px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .stat-card {
        background: var(--surface-bg);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--accent-color);
        margin-bottom: 5px;
        word-break: break-word;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
    }

    .stat-unit {
        font-size: 0.8rem;
        color: var(--text-tertiary);
        margin-top: 4px;
    }

    .settings-section {
        margin-top: 30px;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }

    @media (min-width: 768px) {
        .settings-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
    }

    .device-setting {
        background: var(--surface-bg);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .device-setting:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-medium);
    }

    .device-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .device-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }

    .socket-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .pump-icon {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .device-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    .power-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
    }

    .power-input {
        flex: 1;
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
    }

    .power-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .update-btn {
        padding: 10px 16px;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .update-btn:hover {
        background: var(--accent-dark);
        transform: translateY(-1px);
    }

    .update-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .current-value {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 5px;
        font-weight: 500;
    }

    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: var(--text-secondary);
        flex-direction: column;
        gap: 10px;
    }

    .loading i {
        font-size: 2rem;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-message {
        text-align: center;
        color: var(--error-color);
        padding: 20px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 8px;
        margin: 10px 0;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .bill-info {
        background: var(--surface-bg);
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        border-left: 4px solid var(--accent-color);
    }

    .bill-info h4 {
        margin: 0 0 10px 0;
        color: var(--text-primary);
        font-size: 1rem;
    }

    .bill-rate {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 5px;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .notification.notification-success {
        background: #10b981;
    }

    .notification.notification-error {
        background: #ef4444;
    }

    .notification.notification-info {
        background: #3b82f6;
    }

    .notification.notification-warning {
        background: #f59e0b;
    }

    @media (max-width: 768px) {
        .analytics-container {
            padding: 15px;
        }
        
        .analytics-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-container {
            height: 300px;
        }
        
        .view-controls {
            flex-wrap: wrap;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .power-input-group {
            flex-direction: column;
            align-items: stretch;
        }

        .update-btn {
            justify-content: center;
        }

        .stat-value {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 480px) {
        .analytics-container {
            padding: 10px;
        }

        .analytics-card {
            padding: 16px;
        }

        .device-setting {
            padding: 16px;
        }

        .chart-container {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="analytics-container">
    <!-- Main Analytics Grid -->
    <div class="analytics-grid">
        <!-- Charts Section -->
        <div class="analytics-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Power Consumption Analytics
                </h3>
            </div>
Generated code
<div class="view-controls">
            <button class="view-btn active" data-view="daily">
                <i class="fas fa-calendar-day"></i> Daily View
            </button>
            <button class="view-btn" data-view="devices">
                <i class="fas fa-plug"></i> Device Wise
            </button>
        </div>
        
        <div class="chart-container">
            <div class="loading" id="chartLoading">
                <i class="fas fa-spinner"></i>
                <span>Loading chart data...</span>
            </div>
            <canvas id="mainChart" style="display: none;"></canvas>
        </div>
    </div>

    <!-- Stats Panel -->
    <div class="analytics-card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-bolt"></i>
                Power Statistics
            </h3>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="monthlyUnits">{{monthconsump}}</div>
                <div class="stat-label">Units This Month</div>
                <div class="stat-unit">kWh</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="monthlyBill">{{ bill }}</div>
                <div class="stat-label">TNEB Bill</div>
                <div class="stat-unit">Current Month</div>
            </div>
        </div>

        <div class="bill-info">
            <h4><i class="fas fa-info-circle"></i> TNEB Billing Info</h4>
            <div class="bill-rate">Up to 400 units: Free</div>
            <div class="bill-rate">401-500 units: ₹6.45/unit</div>
            <div class="bill-rate">501-600 units: ₹8.55/unit</div>
            <div class="bill-rate">601-800 units: ₹9.65/unit</div>
            <div class="bill-rate">801-1000 units: ₹10.70/unit</div>
            <div class="bill-rate">Above 1000 units: ₹11.80/unit</div>
        </div>
    </div>
</div>

<!-- Power Settings Section -->
<div class="settings-section">
    <div class="analytics-card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-cog"></i>
                Power Consumption Settings
            </h3>
        </div>
        
        <div class="settings-grid">
            <div class="device-setting">
                <div class="device-header">
                    <div class="device-icon socket-icon">
                        <i class="fas fa-plug"></i>
                    </div>
                    <div class="device-name">Socket 1</div>
                </div>
                <div class="current-value">Current: <span id="socket1Current">{{settings.socket1}}</span> Watts</div>
                <div class="power-input-group">
                    <input type="number" class="power-input" id="socket1Input" placeholder="Power Rating (Watts)" min="1" max="5000">
                    <button class="update-btn" onclick="updatePowerSetting('socket1')">
                        <i class="fas fa-save"></i> Update
                    </button>
                </div>
            </div>

            <div class="device-setting">
                <div class="device-header">
                    <div class="device-icon socket-icon">
                        <i class="fas fa-plug"></i>
                    </div>
                    <div class="device-name">Socket 2</div>
                </div>
                <div class="current-value">Current: <span id="socket2Current">{{settings.socket2}}</span> Watts</div>
                <div class="power-input-group">
                    <input type="number" class="power-input" id="socket2Input" placeholder="Power Rating (Watts)" min="1" max="5000">
                    <button class="update-btn" onclick="updatePowerSetting('socket2')">
                        <i class="fas fa-save"></i> Update
                    </button>
                </div>
            </div>

            <div class="device-setting">
                <div class="device-header">
                    <div class="device-icon pump-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="device-name">Water Pump</div>
                </div>
                <div class="current-value">Current: <span id="water_pumpCurrent">{{settings.water_pump}}</span> Watts</div>
                <div class="power-input-group">
                    <input type="number" class="power-input" id="water_pumpInput" placeholder="Power Rating (Watts)" min="1" max="5000">
                    <button class="update-btn" onclick="updatePowerSetting('water_pump')">
                        <i class="fas fa-save"></i> Update
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}
{% block page_scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let mainChart = null;
let currentView = 'daily';
let chartInitialized = false;
let pendingData = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Analytics page loaded');
    
    // Initialize components in proper sequence
    initializeChart()
        .then(() => {
            console.log('Chart ready, loading data...');
            loadPowerSettings();
            loadMonthlyStats();
            loadChartData();
        })
        .catch(error => {
            console.error('Chart initialization failed:', error);
            showError('Failed to initialize chart: ' + error.message);
        });
    
    // Set up view buttons with proper event handling
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const view = this.dataset.view;
            console.log('View button clicked:', view);
            switchView(view);
        });
    });
    
    // Set up Enter key handling for input fields
    document.querySelectorAll('.power-input').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const deviceName = this.id.replace('Input', '');
                updatePowerSetting(deviceName);
            }
        });
    });
    
    // Refresh data every 30 seconds
    setInterval(() => {
        if (chartInitialized) {
            loadChartData();
            loadMonthlyStats();
        }
    }, 30000);
});

function initializeChart() {
    return new Promise((resolve, reject) => {
        try {
            console.log('Initializing chart...');
            
            // Ensure canvas exists
            const canvas = document.getElementById('mainChart');
            if (!canvas) {
                console.error('Chart canvas not found');
                reject(new Error('Chart canvas not found'));
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Create initial empty chart
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Loading...'],
                    datasets: [{
                        label: 'Power Consumption (kWh)',
                        data: [0],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: getChartOptions(isDarkMode, 'line')
            });
            
            chartInitialized = true;
            console.log('Chart initialized successfully');
            
            // Process any pending data
            if (pendingData) {
                console.log('Processing pending data...');
                updateChart(pendingData);
                pendingData = null;
            }
            
            resolve();
            
        } catch (error) {
            console.error('Error initializing chart:', error);
            reject(error);
        }
    });
}

function getChartOptions(isDarkMode, chartType) {
    const textColor = isDarkMode ? '#e5e7eb' : '#374151';
    const gridColor = isDarkMode ? 'rgba(75, 85, 99, 0.2)' : 'rgba(209, 213, 219, 0.3)';
    
    return {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            duration: 750
        },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    color: textColor,
                    font: {
                        family: 'Inter',
                        size: 12,
                        weight: '500'
                    },
                    usePointStyle: chartType === 'line',
                    padding: 20
                }
            },
            tooltip: {
                backgroundColor: isDarkMode ? '#1f2937' : '#ffffff',
                titleColor: textColor,
                bodyColor: textColor,
                borderColor: '#667eea',
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: false,
                callbacks: {
                    label: function(context) {
                        return `${context.parsed.y.toFixed(3)} kWh`;
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    color: gridColor,
                    drawBorder: false
                },
                ticks: {
                    color: textColor,
                    font: {
                        family: 'Inter',
                        size: 11
                    },
                    maxTicksLimit: chartType === 'line' ? 10 : 6
                }
            },
            y: {
                beginAtZero: true,
                grid: {
                    color: gridColor,
                    drawBorder: false
                },
                ticks: {
                    color: textColor,
                    font: {
                        family: 'Inter',
                        size: 11
                    },
                    callback: function(value) {
                        return value.toFixed(2) + ' kWh';
                    }
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    };
}

function switchView(view) {
    console.log('Switching view from', currentView, 'to', view);
    
    if (currentView === view) {
        console.log('Same view selected, skipping...');
        return;
    }
    
    currentView = view;
    
    // Update button states
    document.querySelectorAll('.view-btn').forEach(btn => {
        if (btn.dataset.view === view) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    console.log('Button states updated, loading data...');
    
    // Show loading state
    showLoadingState();
    
    // Load new chart data with delay for better UX
    setTimeout(() => {
        loadChartData();
    }, 200);
}

function showLoadingState() {
    const loadingElement = document.getElementById('chartLoading');
    const chartElement = document.getElementById('mainChart');
    if (loadingElement && chartElement) {
        loadingElement.style.display = 'flex';
        chartElement.style.display = 'none';
    }
}

function hideLoadingState() {
    const loadingElement = document.getElementById('chartLoading');
    const chartElement = document.getElementById('mainChart');
    if (loadingElement && chartElement) {
        loadingElement.style.display = 'none';
        chartElement.style.display = 'block';
    }
}

function loadChartData() {
    const endpoint = currentView === 'daily' ? 
        '/api/analytics/daily_consumption' : 
        '/api/analytics/device_consumption';
        
    console.log('Loading data from:', endpoint);
    
    
    
    fetch(endpoint)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            
            if (data.success && data.data) {
                if (Array.isArray(data.data) && data.data.length > 0) {
                    if (chartInitialized && mainChart) {
                        updateChart(data.data);
                        hideLoadingState();
                    } else {
                        // Store data for when chart is ready
                        pendingData = data.data;
                        console.log('Chart not ready, storing data for later...');
                    }
                } else {
                    console.log('No data available, using sample data');
                    const sampleData = getSampleData();
                    if (chartInitialized && mainChart) {
                        updateChart(sampleData);
                        hideLoadingState();
                    } else {
                        pendingData = sampleData;
                    }
                    showNotification('No real data available, showing sample data', 'info');
                }
            } else {
                throw new Error(data.error || 'Invalid data format received');
            }
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            
            // Show sample data on error
            const sampleData = getSampleData();
            if (chartInitialized && mainChart) {
                updateChart(sampleData);
                hideLoadingState();
            } else {
                pendingData = sampleData;
            }
            showNotification('Connection error - showing sample data', 'warning');
        });
}

function getSampleData() {
    const today = new Date();
    
    if (currentView === 'daily') {
        const data = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            data.push({
                date: date.toISOString(),
                units: Math.random() * 3 + 1 // Random between 1-4 kWh
            });
        }
        return data;
    } else {
        return [
            { device: 'Socket 1', units: Math.random() * 2 + 0.5 },
            { device: 'Socket 2', units: Math.random() * 1.5 + 0.3 },
            { device: 'Water Pump', units: Math.random() * 3 + 1 }
        ];
    }
}

function updateChart(data) {
    if (!mainChart || !chartInitialized) {
        console.error('Chart not available for update');
        pendingData = data; // Store for later
        return;
    }
    
    try {
        console.log('Updating chart with data:', data);
        console.log('Current view:', currentView);
        
        const isDarkMode = document.body.classList.contains('dark-mode');
        const newType = currentView === 'daily' ? 'line' : 'bar';
        
        // Check if we need to recreate the chart for type change
        if (mainChart.config.type !== newType) {
            console.log(`Changing chart type from ${mainChart.config.type} to ${newType}`);
            
            // Get the canvas element
            const canvas = document.getElementById('mainChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            mainChart.destroy();
            
            // Create new chart with correct type
            mainChart = new Chart(ctx, {
                type: newType,
                data: { labels: [], datasets: [] },
                options: getChartOptions(isDarkMode, newType)
            });
        }
        
        // Clear existing data
        mainChart.data.labels = [];
        mainChart.data.datasets = [];
        
        if (currentView === 'daily') {
            console.log('Updating for daily view...');
            
            // Set daily data
            mainChart.data.labels = data.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            mainChart.data.datasets = [{
                label: 'Daily Power Consumption (kWh)',
                data: data.map(item => parseFloat(item.units) || 0),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 8
            }];
            
        } else {
            console.log('Updating for device view...');
            
            // Set device data
            mainChart.data.labels = data.map(item => item.device || 'Unknown Device');
            
            mainChart.data.datasets = [{
                label: 'Today\'s Power Consumption (kWh)',
                data: data.map(item => parseFloat(item.units) || 0),
                backgroundColor: [
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(118, 75, 162, 0.8)',
                    'rgba(240, 147, 251, 0.8)'
                ],
                borderColor: [
                    '#667eea',
                    '#764ba2',
                    '#f093fb'
                ],
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false
            }];
        }
        
        // Update the chart
        mainChart.update('active');
        
        console.log('Chart updated successfully');
        
    } catch (error) {
        console.error('Error updating chart:', error);
        showError('Error updating chart: ' + error.message);
    }
}

function loadPowerSettings() {
    fetch('/api/analytics/power_settings')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.settings) {
                const settings = data.settings;
                
                // Update current values display
                const socket1Current = document.getElementById('socket1Current');
                const socket2Current = document.getElementById('socket2Current');
                const pumpCurrent = document.getElementById('water_pumpCurrent');
                
                if (socket1Current) socket1Current.textContent = settings.socket1;
                if (socket2Current) socket2Current.textContent = settings.socket2;
                if (pumpCurrent) pumpCurrent.textContent = settings.water_pump;
                
                // Set input placeholders
                const socket1Input = document.getElementById('socket1Input');
                const socket2Input = document.getElementById('socket2Input');
                const pumpInput = document.getElementById('water_pumpInput');
                
                if (socket1Input) socket1Input.placeholder = `Current: ${settings.socket1}W`;
                if (socket2Input) socket2Input.placeholder = `Current: ${settings.socket2}W`;
                if (pumpInput) pumpInput.placeholder = `Current: ${settings.water_pump}W`;
            }
        })
        .catch(error => {
            console.error('Error loading power settings:', error);
        });
}

function loadMonthlyStats() {
    fetch('/api/analytics/monthly_stats')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.data) {
                const stats = data.data;
                const monthlyUnits = document.getElementById('monthlyUnits');
                const monthlyBill = document.getElementById('monthlyBill');
                
                if (monthlyUnits) monthlyUnits.textContent = stats.total_units.toFixed(2);
                if (monthlyBill) monthlyBill.textContent = `₹${stats.bill_amount.toFixed(2)}`;
            }
        })
        .catch(error => {
            console.error('Error loading monthly stats:', error);
        });
}

function updatePowerSetting(deviceName) {
    const inputElement = document.getElementById(`${deviceName}Input`);
    if (!inputElement) {
        console.error('Input element not found for device:', deviceName);
        return;
    }
    
    const powerRating = parseFloat(inputElement.value);
    
    if (!powerRating || powerRating <= 0) {
        showNotification('Please enter a valid power rating greater than 0', 'warning');
        return;
    }
    
    if (powerRating > 5000) {
        showNotification('Power rating cannot exceed 5000 watts', 'warning');
        return;
    }
    
    const updateBtn = inputElement.nextElementSibling;
    if (!updateBtn) {
        console.error('Update button not found');
        return;
    }
    
    const originalText = updateBtn.innerHTML;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    updateBtn.disabled = true;
    
    fetch('/api/analytics/power_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device_name: deviceName,
            power_rating: powerRating
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Update the current value display
            const currentElement = document.getElementById(`${deviceName}Current`);
            if (currentElement) {
                currentElement.textContent = powerRating;
            }
            
            inputElement.value = '';
            inputElement.placeholder = `Current: ${powerRating}W`;
            
            // Show success message
            showNotification('Settings updated successfully!', 'success');
        } else {
            showNotification('Error updating settings: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating settings: ' + error.message, 'error');
    })
    .finally(() => {
        updateBtn.innerHTML = originalText;
        updateBtn.disabled = false;
    });
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => {
        notification.remove();
    });
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

function showError(message) {
    const chartLoading = document.getElementById('chartLoading');
    if (!chartLoading) return;
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <div>${message}</div>
    `;
    
    chartLoading.innerHTML = '';
    chartLoading.appendChild(errorDiv);
    chartLoading.style.display = 'flex';
}

// Theme change handler for chart colors
function updateChartColors() {
    if (mainChart && chartInitialized) {
        const isDarkMode = document.body.classList.contains('dark-mode');
        const chartType = currentView === 'daily' ? 'line' : 'bar';
        mainChart.options = getChartOptions(isDarkMode, chartType);
        mainChart.update('none');
    }
}

// Listen for theme changes
document.addEventListener('themeChanged', updateChartColors);
</script>
{% endblock %}
