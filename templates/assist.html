{% extends "layout.html" %}
{% block page_title %}Assist Mode{% endblock %}
{% block page_styles %}
<style>
    .assist-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }
    
    .mic-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 30px;
        text-align: center;
        box-shadow: var(--shadow-light);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }
    
    .mic-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-heavy);
    }
    
    .mode-indicator {
        font-size: 1.3rem;
        margin-bottom: 25px;
        font-weight: 600;
        color: var(--heading-text);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        position: relative;
        z-index: 2;
    }
    
    .mode-indicator.processing {
        color: var(--warning);
        animation: glow 1s ease-in-out infinite alternate;
    }
    
    .mic-button {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        background: var(--sidebar-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 
            0 8px 25px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.1),
            inset 0 -1px 0 rgba(0, 0, 0, 0.05);
        position: relative;
        z-index: 2;
        border: 2px solid var(--border-color);
    }
    
    .mic-button:hover {
        transform: scale(1.05);
        box-shadow: 
            0 12px 30px rgba(0, 0, 0, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    .mic-button.listening {
        animation: pulse-mic 1.2s infinite;
        background: linear-gradient(135deg, var(--primary-accent), var(--info));
    }
    
    .mic-button.processing {
        background: linear-gradient(135deg, var(--warning), var(--danger));
        animation: processingPulse 0.8s ease-in-out infinite;
    }
    
    .mic-button i {
        font-size: 55px;
        color: var(--primary-accent);
        transition: all 0.4s;
    }
    
    .mic-button.listening i,
    .mic-button.processing i {
        color: white;
    }
    
    .command-text {
        margin-top: 30px;
        min-height: 90px;
        font-size: 1.25rem;
        color: var(--primary-text);
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        transition: all 0.4s;
        position: relative;
        z-index: 2;
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        line-height: 1.5;
    }
    
    .command-text.processing {
        background: rgba(var(--warning-rgb), 0.1);
        border-color: var(--warning);
    }
    
    .command-text.success {
        background: rgba(var(--success-rgb), 0.1);
        border-color: var(--success);
    }
    
    .command-text.error {
        background: rgba(var(--danger-rgb), 0.1);
        border-color: var(--danger);
    }
    
    .input-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 30px;
        position: relative;
        z-index: 2;
    }
    
    .input-group {
        display: flex;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    
    .input-group input {
        flex: 1;
        padding: 18px 25px;
        border: none;
        font-size: 1.1rem;
        background: var(--sidebar-bg);
        color: var(--primary-text);
        outline: none;
        transition: all 0.3s;
    }
    
    .input-group input:focus {
        background: var(--card-bg);
    }
    
    .input-group input::placeholder {
        color: var(--secondary-text);
        font-style: italic;
    }
    
    .input-group button {
        background: linear-gradient(135deg, var(--primary-accent), var(--info));
        color: white;
        border: none;
        padding: 18px 30px;
        cursor: pointer;
        font-size: 1.1rem;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .input-group button:hover {
        background: linear-gradient(135deg, var(--info), var(--primary-accent));
        transform: translateY(-2px);
    }
    
    .input-group button:active {
        transform: translateY(0);
    }
    
    .suggestions {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        margin-top: 25px;
    }
    
    .suggestion {
        background: rgba(255, 255, 255, 0.05);
        color: var(--primary-text);
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid var(--border-color);
        backdrop-filter: blur(5px);
        position: relative;
        overflow: hidden;
    }
    
    .suggestion:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
    }
    
    .suggestion:hover:before {
        left: 100%;
    }
    
    .suggestion:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .history-panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 30px;
        box-shadow: var(--shadow-light);
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        position: relative;
    }
    
    .history-panel::-webkit-scrollbar {
        width: 8px;
    }
    
    .history-panel::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 4px;
    }
    
    .history-panel::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--primary-accent), var(--info));
        border-radius: 4px;
    }
    
    .history-panel h3 {
        text-align: center;
        margin-bottom: 25px;
        color: var(--heading-text);
        font-weight: 600;
        font-size: 1.4rem;
    }
    
    .history-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .history-controls button {
        background: linear-gradient(135deg, var(--primary-accent), var(--info));
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
    }
    
    .history-controls button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .history-item {
        padding: 18px 20px;
        margin: 18px 0;
        border-radius: 14px;
        animation: slideInUp 0.5s ease-out;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(5px);
        border: 1px solid var(--border-color);
    }
    
    .history-item:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        border-radius: 0 5px 5px 0;
    }
    
    .history-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .user-message {
        background: linear-gradient(135deg, rgba(35, 106, 217, 0.1) 0%, rgba(35, 106, 217, 0.05) 100%);
        text-align: right;
        margin-left: 15%;
        color: var(--info);
    }
    
    .user-message:before {
        background: linear-gradient(135deg, var(--info), var(--primary-accent));
    }
    
    .assistant-message {
        background: linear-gradient(135deg, rgba(63, 185, 80, 0.05) 0%, rgba(63, 185, 80, 0.1) 100%);
        text-align: left;
        margin-right: 15%;
        color: var(--success);
    }
    
    .assistant-message.action-performed {
        background: linear-gradient(135deg, rgba(63, 185, 80, 0.1) 0%, rgba(63, 185, 80, 0.15) 100%);
        border: 1px solid rgba(63, 185, 80, 0.2);
    }
    
    .assistant-message.action-performed:before {
        background: linear-gradient(135deg, var(--success), #2e7d32);
    }
    
    .status-indicators {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .status-indicator {
        background: rgba(255, 255, 255, 0.05);
        padding: 10px 15px;
        border-radius: 20px;
        color: var(--primary-text);
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        transition: all 0.3s;
    }
    
    .status-indicator.active {
        background: rgba(63, 185, 80, 0.1);
        border-color: var(--success);
        animation: statusPulse 2s infinite;
    }
    
    .empty-state {
        text-align: center;
        color: var(--secondary-text);
        font-style: italic;
        padding: 40px 20px;
        background: rgba(255,255,255,0.03);
        border-radius: 15px;
        margin: 20px 0;
    }
    
    .message-content {
        font-size: 1.1rem;
        line-height: 1.5;
    }
    
    .message-time {
        font-size: 0.8rem;
        color: var(--secondary-text);
        margin-top: 8px;
        text-align: right;
    }
    
    .user-message .message-time {
        text-align: left;
    }
    
    @keyframes pulse-mic {
        0% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.5); }
        70% { box-shadow: 0 0 0 20px rgba(88, 166, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0); }
    }
    
    @keyframes processingPulse {
        0%, 100% { transform: scale(1); opacity: 0.9; }
        50% { transform: scale(1.05); opacity: 1; }
    }
    
    @keyframes glow {
        from { text-shadow: 0 0 10px rgba(247, 164, 43, 0.5); }
        to { text-shadow: 0 0 20px rgba(247, 164, 43, 0.8); }
    }
    
    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes statusPulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }
    
    @media (max-width: 768px) {
        .assist-container {
            padding: 15px;
        }
        
        .mic-card {
            padding: 25px;
        }
        
        .mic-button {
            width: 110px;
            height: 110px;
        }
        
        .mic-button i {
            font-size: 45px;
        }
        
        .command-text {
            font-size: 1.15rem;
            min-height: 70px;
            padding: 15px;
        }
        
        .history-item {
            margin-left: 5%;
            margin-right: 5%;
        }
        
        .suggestions {
            gap: 8px;
        }
        
        .suggestion {
            padding: 8px 15px;
            font-size: 0.85rem;
        }
        
        .history-controls button {
            padding: 8px 15px;
        }
    }
    
    @media (max-width: 480px) {
        .mode-indicator {
            font-size: 1.1rem;
            letter-spacing: 1px;
        }
        
        .mic-button {
            width: 90px;
            height: 90px;
        }
        
        .mic-button i {
            font-size: 35px;
        }
        
        .command-text {
            font-size: 1rem;
            min-height: 60px;
        }
        
        .input-group input,
        .input-group button {
            padding: 12px 15px;
            font-size: 1rem;
        }
        
        .status-indicators {
            gap: 10px;
        }
        
        .status-indicator {
            padding: 8px 12px;
            font-size: 0.8rem;
        }
        
        .history-panel {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="assist-container">
    <div class="mic-card">
        <div class="mode-indicator" id="modeIndicator">Ready to listen</div>
        
        <div class="mic-button" id="micButton">
            <i class="fas fa-microphone" id="micIcon"></i>
        </div>
        
        <div class="command-text" id="commandText">
            Click the microphone and speak your command
        </div>
        
        <div class="status-indicators">
            <div class="status-indicator" id="connectionStatus">
                <i class="fas fa-wifi"></i> Connected
            </div>
            <div class="status-indicator" id="processingStatus">
                <i class="fas fa-cog"></i> Ready
            </div>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <input type="text" id="textInput" placeholder="Or type your command here..." autocomplete="off">
                <button id="textSubmit">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <div class="suggestions">
                <div class="suggestion" data-command="What's the temperature?">
                    <i class="fas fa-thermometer-half"></i> Temperature
                </div>
                <div class="suggestion" data-command="Is it raining?">
                    <i class="fas fa-cloud-rain"></i> Weather
                </div>
                <div class="suggestion" data-command="Turn on socket one">
                    <i class="fas fa-plug"></i> Control devices
                </div>
                <div class="suggestion" data-command="Who entered yesterday?">
                    <i class="fas fa-door-open"></i> Access log
                </div>
                <div class="suggestion" data-command="Water tank level">
                    <i class="fas fa-tint"></i> Water level
                </div>
                <div class="suggestion" data-command="Show notifications">
                    <i class="fas fa-bell"></i> Notifications
                </div>
            </div>
        </div>
    </div>
    
    <div class="history-panel">
        <h3><i class="fas fa-history"></i> Command History</h3>
        
        <div class="history-controls">
            <button onclick="clearHistory()">
                <i class="fas fa-trash"></i> Clear History
            </button>
            <button onclick="refreshHistory()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button onclick="exportHistory()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
        
        <div id="historyContainer">
            {% for item in history %}
                <div class="history-item {% if item.type == 'input' %}user-message{% else %}assistant-message{% if item.action_performed %} action-performed{% endif %}{% endif %}">
                    <div class="message-content">
                        {{ item.user if item.type == 'input' else item.assistant }}
                    </div>
                    {% if item.get('timestamp') %}
                        <div class="message-time">
                            {{ moment(item.timestamp).format('HH:mm') }}
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <p>No commands yet. Your interactions will appear here.</p>
                    <small>Try saying "What's the temperature?" or click a suggestion above.</small>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const micButton = document.getElementById('micButton');
    const micIcon = document.getElementById('micIcon');
    const modeIndicator = document.getElementById('modeIndicator');
    const commandText = document.getElementById('commandText');
    const historyContainer = document.getElementById('historyContainer');
    const textInput = document.getElementById('textInput');
    const textSubmit = document.getElementById('textSubmit');
    const suggestions = document.querySelectorAll('.suggestion');
    const connectionStatus = document.getElementById('connectionStatus');
    const processingStatus = document.getElementById('processingStatus');
    
    // State variables
    let isListening = false;
    let isProcessing = false;
    let recognition = null;
    let speechSynthesis = window.speechSynthesis;
    let commandCount = 0;
    
    // Initialize Speech Recognition with enhanced error handling
    function initSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                console.log('Speech recognition started');
                updateUI('listening');
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (interimTranscript) {
                    commandText.textContent = interimTranscript;
                }
                
                if (finalTranscript) {
                    processVoiceCommand(finalTranscript.trim());
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                
                let errorMsg = 'Speech recognition error. ';
                switch(event.error) {
                    case 'network':
                        errorMsg += 'Network issue. Please check your internet connection.';
                        break;
                    case 'not-allowed':
                    case 'permission-denied':
                        errorMsg += 'Microphone access denied. Please allow microphone permissions.';
                        break;
                    case 'service-not-allowed':
                        errorMsg += 'Browser speech service not available. Try another browser.';
                        break;
                    default:
                        errorMsg += 'Please try again.';
                }
                
                updateUI('error');
                commandText.textContent = errorMsg;
                isListening = false;
                setTimeout(() => updateUI('ready'), 3000);
            };
            
            recognition.onend = function() {
                if (isListening && !isProcessing) {
                    updateUI('ready');
                }
            };
        } else {
            console.warn('Speech recognition not supported');
            micButton.style.opacity = '0.5';
            micButton.title = 'Speech recognition not supported in this browser';
            commandText.textContent = 'Speech recognition not supported in your browser';
        }
    }

    // Initialize speech recognition
    initSpeechRecognition();

    // Event Listeners
    micButton.addEventListener('click', handleMicClick);
    textSubmit.addEventListener('click', handleTextSubmit);
    textInput.addEventListener('keypress', handleKeyPress);
    textInput.addEventListener('input', handleInputChange);
    
    // Add suggestion click handlers
    suggestions.forEach(suggestion => {
        suggestion.addEventListener('click', function() {
            const command = this.getAttribute('data-command');
            processTextCommand(command);
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
    
    // Functions
    function handleMicClick() {
        if (!recognition) {
            showNotification('Speech recognition not supported', 'error');
            return;
        }
        
        // Check if we're in secure context (HTTPS required for speech recognition)
        if (window.isSecureContext === false) {
            showNotification('Microphone requires HTTPS connection', 'error');
            commandText.textContent = 'Voice commands require secure HTTPS connection';
            return;
        }
        
        if (!isListening && !isProcessing) {
            // Explicitly request microphone permissions
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    // Stop all tracks to release microphone immediately
                    stream.getTracks().forEach(track => track.stop());
                    startListening();
                })
                .catch(function(err) {
                    console.error('Microphone access error:', err);
                    updateUI('error');
                    commandText.textContent = 'Microphone access denied. Please enable permissions.';
                    setTimeout(() => updateUI('ready'), 3000);
                });
        } else if (isListening) {
            stopListening();
        }
    }
    
    function handleTextSubmit() {
        const command = textInput.value.trim();
        if (command && !isProcessing) {
            processTextCommand(command);
            textInput.value = '';
        }
    }
    
    function handleKeyPress(e) {
        if (e.key === 'Enter' && !isProcessing) {
            handleTextSubmit();
        }
    }
    
    function handleInputChange(e) {
        const value = e.target.value;
        if (value.length > 0) {
            textSubmit.style.background = 'linear-gradient(135deg, var(--success), #2e7d32)';
        } else {
            textSubmit.style.background = 'linear-gradient(135deg, var(--primary-accent), var(--info))';
        }
    }
    
    function startListening() {
        if (!recognition || isProcessing) return;
        
        try {
            isListening = true;
            recognition.start();
            updateUI('listening');
        } catch (error) {
            console.error('Failed to start recognition:', error);
            updateUI('error');
            commandText.textContent = 'Error starting voice recognition';
            setTimeout(() => updateUI('ready'), 3000);
        }
    }
    
    function stopListening() {
        if (!recognition) return;
        
        isListening = false;
        try {
            recognition.stop();
        } catch (e) {
            console.log('Recognition already stopped');
        }
        updateUI('ready');
    }
    
    function processVoiceCommand(command) {
        if (!command) return;
        
        stopListening();
        processTextCommand(command);
    }
    
    function processTextCommand(command) {
        if (isProcessing) return;
        
        isProcessing = true;
        commandCount++;
        
        updateUI('processing');
        addToHistory(command, 'input');
        
        // Show typing indicator
        commandText.textContent = 'Processing your command...';
        
        const startTime = Date.now();
        
        fetch('/assist/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                text: command 
            })
        })
        .then(response => response.json())
        .then(data => {
            const processingTime = Date.now() - startTime;
            
            if (data.status === 'success') {
                commandText.textContent = data.text;
                addToHistory(data.text, 'response', {
                    action_performed: data.action_performed,
                    intent: data.intent,
                    confidence: data.confidence,
                    processing_time: processingTime
                });
                
                updateUI('success');
                
                // Speak the response if supported and enabled
                if (data.should_speak && speechSynthesis) {
                    speakResponse(data.text);
                }
                
                // Show success notification for actions
                if (data.action_performed) {
                    showNotification('Action completed successfully!', 'success');
                }
                
            } else {
                commandText.textContent = data.text || "Could not process command. Please try again.";
                updateUI('error');
                showNotification('Command failed', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            commandText.textContent = "Connection error. Please try again.";
            updateUI('error');
            showNotification('Connection error', 'error');
        })
        .finally(() => {
            isProcessing = false;
            setTimeout(() => {
                if (!isListening) {
                    updateUI('ready');
                }
            }, 2000);
        });
    }
    
    function updateUI(state) {
        // Reset classes
        micButton.classList.remove('listening', 'processing');
        commandText.classList.remove('processing', 'success', 'error');
        modeIndicator.classList.remove('processing');
        processingStatus.classList.remove('active');
        
        switch (state) {
            case 'listening':
                micButton.classList.add('listening');
                modeIndicator.textContent = 'Listening...';
                modeIndicator.classList.add('processing');
                micIcon.className = 'fas fa-microphone';
                processingStatus.innerHTML = '<i class="fas fa-ear-listen"></i> Listening';
                processingStatus.classList.add('active');
                break;
                
            case 'processing':
                micButton.classList.add('processing');
                commandText.classList.add('processing');
                modeIndicator.textContent = 'Processing...';
                modeIndicator.classList.add('processing');
                micIcon.className = 'fas fa-cog fa-spin';
                processingStatus.innerHTML = '<i class="fas fa-cog fa-spin"></i> Processing';
                processingStatus.classList.add('active');
                break;
                
            case 'success':
                commandText.classList.add('success');
                modeIndicator.textContent = 'Command completed';
                micIcon.className = 'fas fa-check';
                processingStatus.innerHTML = '<i class="fas fa-check"></i> Success';
                break;
                
            case 'error':
                commandText.classList.add('error');
                modeIndicator.textContent = 'Error occurred';
                micIcon.className = 'fas fa-exclamation-triangle';
                processingStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                break;
                
            case 'ready':
            default:
                modeIndicator.textContent = 'Ready to listen';
                micIcon.className = 'fas fa-microphone';
                processingStatus.innerHTML = '<i class="fas fa-cog"></i> Ready';
                if (commandCount === 0) {
                    commandText.textContent = 'Click the microphone and speak your command';
                }
                break;
        }
    }
    
    function speakResponse(text) {
        if (!speechSynthesis || !text) return;
        
        // Cancel any ongoing speech
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 0.8;
        
        // Try to use a pleasant voice
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(voice => 
            voice.lang.startsWith('en') && 
            (voice.name.includes('Female') || voice.name.includes('Google'))
        );
        if (preferredVoice) {
            utterance.voice = preferredVoice;
        }
        
        utterance.onstart = () => {
            processingStatus.innerHTML = '<i class="fas fa-volume-up"></i> Speaking';
            processingStatus.classList.add('active');
        };
        
        utterance.onend = () => {
            processingStatus.innerHTML = '<i class="fas fa-cog"></i> Ready';
            processingStatus.classList.remove('active');
        };
        
        speechSynthesis.speak(utterance);
    }
    
    function addToHistory(text, type, metadata = {}) {
        const historyItem = document.createElement('div');
        historyItem.classList.add('history-item');
        historyItem.classList.add(type === 'input' ? 'user-message' : 'assistant-message');
        
        if (type === 'response' && metadata.action_performed) {
            historyItem.classList.add('action-performed');
        }
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = text;
        historyItem.appendChild(messageContent);
        
        // Add metadata for responses
        if (type === 'response' && metadata.intent) {
            const metaInfo = document.createElement('div');
            metaInfo.className = 'message-meta';
            metaInfo.innerHTML = `
                <small>
                    <i class="fas fa-brain"></i> ${metadata.intent}
                    ${metadata.confidence ? `(${Math.round(metadata.confidence * 100)}%)` : ''}
                    ${metadata.processing_time ? `â€¢ ${metadata.processing_time}ms` : ''}
                </small>
            `;
            historyItem.appendChild(metaInfo);
        }
        
        // Add timestamp
        const timestamp = document.createElement('div');
        timestamp.className = 'message-time';
        timestamp.textContent = new Date().toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
        historyItem.appendChild(timestamp);
        
        // Remove empty state if present
        const emptyState = historyContainer.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        historyContainer.insertBefore(historyItem, historyContainer.firstChild);
        
        // Limit history items in DOM
        const historyItems = historyContainer.querySelectorAll('.history-item');
        if (historyItems.length > 50) {
            historyItems[historyItems.length - 1].remove();
        }
        
        // Scroll to top smoothly
        historyContainer.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                              type === 'error' ? 'exclamation-circle' : 
                              'info-circle'}"></i>
            ${message}
        `;
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            max-width: 300px;
        `;
        
        switch (type) {
            case 'success':
                notification.style.background = 'linear-gradient(135deg, var(--success), #2e7d32)';
                break;
            case 'error':
                notification.style.background = 'linear-gradient(135deg, var(--danger), #d32f2f)';
                break;
            default:
                notification.style.background = 'linear-gradient(135deg, var(--primary-accent), var(--info))';
        }
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    function getCsrfToken() {
        const token = document.querySelector('meta[name="csrf-token"]');
        return token ? token.getAttribute('content') : '';
    }
    
    // Global functions for history controls
    window.clearHistory = function() {
        if (confirm('Are you sure you want to clear the command history?')) {
            fetch('/assist/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
               
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    historyContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>History cleared. Your new interactions will appear here.</p>
                        </div>
                    `;
                    showNotification('History cleared successfully', 'success');
                }
            })
            .catch(error => {
                console.error('Error clearing history:', error);
                showNotification('Failed to clear history', 'error');
            });
        }
    };
    
    window.refreshHistory = function() {
        fetch('/assist/history')
        .then(response => response.json())
        .then(data => {
            // Refresh the history display
            const history = data.history || [];
            historyContainer.innerHTML = '';
            
            if (history.length === 0) {
                historyContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No commands yet. Your interactions will appear here.</p>
                    </div>
                `;
            } else {
                history.reverse().forEach(item => {
                    if (item.type === 'input') {
                        addToHistory(item.user, 'input');
                    } else {
                        addToHistory(item.assistant, 'response', {
                            action_performed: item.action_performed,
                            intent: item.intent
                        });
                    }
                });
            }
            
            showNotification('History refreshed', 'success');
        })
        .catch(error => {
            console.error('Error refreshing history:', error);
            showNotification('Failed to refresh history', 'error');
        });
    };
    
    window.exportHistory = function() {
        fetch('/assist/history')
        .then(response => response.json())
        .then(data => {
            const history = data.history || [];
            const exportData = {
                exported_at: new Date().toISOString(),
                total_commands: history.filter(h => h.type === 'input').length,
                history: history
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `assist-history-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('History exported successfully', 'success');
        })
        .catch(error => {
            console.error('Error exporting history:', error);
            showNotification('Failed to export history', 'error');
        });
    };
    
    // Initialize connection status
    function checkConnection() {
        if (!navigator.onLine) {
            connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Disconnected';
            connectionStatus.style.background = 'rgba(244, 67, 54, 0.1)';
            connectionStatus.style.borderColor = 'var(--danger)';
            return;
        }

        // Check speech API specifically
        fetch('https://www.google.com', { mode: 'no-cors' })
            .then(() => {
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Connected';
                connectionStatus.style.background = 'rgba(63, 185, 80, 0.1)';
                connectionStatus.style.borderColor = 'var(--success)';
            })
            .catch(() => {
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Limited Access';
                connectionStatus.style.background = 'rgba(247, 164, 43, 0.1)';
                connectionStatus.style.borderColor = 'var(--warning)';
            });
    }
    
    // Check connection every 30 seconds
    setInterval(checkConnection, 30000);
    checkConnection();
    
    // Auto-focus text input
    textInput.focus();
    
    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        .message-meta {
            font-size: 0.8rem;
            color: var(--secondary-text);
            margin-top: 5px;
            opacity: 0.7;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    // Initialize speech synthesis voices (load them)
    if (speechSynthesis) {
        speechSynthesis.getVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                speechSynthesis.getVoices();
            };
        }
    }
    
    console.log('Enhanced Assist Mode initialized successfully');
});
</script>
{% endblock %}
